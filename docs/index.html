<!DOCTYPE html><html lang="en-us"><head> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-61575797-6"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-61575797-6'); </script><link href="http://gmpg.org/xfn/11" rel="profile"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><title> tensor.blog &middot; thinking machines</title><link rel="canonical" href="http://localhost:4000/"><style> *{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;font-size:16px;line-height:1.5}@media (min-width: 38em){html{font-size:20px}}body{color:#515151;background-color:#fff;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%}a{color:#268bd2;text-decoration:none}a strong{color:inherit}a:hover,a:focus{text-decoration:underline}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:bold;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}h3{margin-top:1.5rem;font-size:1.25rem}h4,h5,h6{margin-top:1rem;font-size:1rem}p{margin-top:0;margin-bottom:1rem}strong{color:#303030}ul,ol,dl{margin-top:0;margin-bottom:1rem}dt{font-weight:bold}dd{margin-bottom:.5rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}abbr{font-size:85%;font-weight:bold;color:#555;text-transform:uppercase}abbr[title]{cursor:help;border-bottom:1px dotted #e5e5e5}code,pre{font-family:Menlo, Monaco, "Courier New", monospace}code{padding:.25em .5em;font-size:85%;color:#bf616a;background-color:#f9f9f9;border-radius:3px}pre{display:block;margin-top:0;margin-bottom:1rem;padding:1rem;font-size:.8rem;line-height:1.4;white-space:pre;white-space:pre-wrap;word-break:break-all;word-wrap:break-word;background-color:#f9f9f9}pre code{padding:0;font-size:100%;color:inherit;background-color:transparent}.highlight{margin-bottom:1rem;border-radius:4px}.highlight pre{margin-bottom:0}.gist .gist-file{font-family:Menlo, Monaco, "Courier New", monospace !important}.gist .markdown-body{padding:15px}.gist pre{padding:0;background-color:transparent}.gist .gist-file .gist-data{font-size:.8rem !important;line-height:1.4}.gist code{padding:0;color:inherit;background-color:transparent;border-radius:0}blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}blockquote p:last-child{margin-bottom:0}@media (min-width: 30em){blockquote{padding-right:5rem;padding-left:1.25rem}}img{display:block;max-width:100%;margin:0 auto 1rem auto;border-radius:5px}img.inline{display:inline;margin:0;border-radius:0;position:relative;top:2px}table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}td,th{padding:.25rem .5rem;border:1px solid #e5e5e5}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#f9f9f9}.lead{font-size:1.25rem;font-weight:300}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans", Helvetica, Arial, sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media (min-width: 30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}html,body{overflow-x:hidden}html{font-family:"PT Serif", Georgia, "Times New Roman", serif}h1,h2,h3,h4,h5,h6{font-family:"PT Sans", Helvetica, Arial, sans-serif;font-weight:400;color:#313131;letter-spacing:-.025rem}.wrap{position:relative;width:100%}.container{max-width:28rem}@media (min-width: 38em){.container{max-width:32rem}}@media (min-width: 56em){.container{max-width:38rem}}.masthead{padding-top:1rem;padding-bottom:1rem;margin-bottom:3rem;border-bottom:1px solid #eee}.masthead-title{margin-top:0;margin-bottom:0;color:#505050}.masthead-title a{color:#505050}.masthead-title small{font-size:75%;font-weight:400;color:#c0c0c0;letter-spacing:0}@media (max-width: 48em){.masthead-title{text-align:center}.masthead-title small{display:none}}.sidebar{position:fixed;top:0;bottom:0;left:-14rem;width:14rem;visibility:hidden;overflow-y:auto;font-family:"PT Sans", Helvetica, Arial, sans-serif;font-size:.875rem;color:rgba(255,255,255,0.6);background-color:#202020;-webkit-transition:all .3s ease-in-out;transition:all .3s ease-in-out}@media (min-width: 30em){.sidebar{font-size:.75rem}}.sidebar a{font-weight:normal;color:#fff}.sidebar-item{padding:1rem}.sidebar-item p:last-child{margin-bottom:0}.sidebar-nav{border-bottom:1px solid rgba(255,255,255,0.1)}.sidebar-nav-item{display:block;padding:.5rem 1rem;border-top:1px solid rgba(255,255,255,0.1)}.sidebar-nav-item.active,a.sidebar-nav-item:hover,a.sidebar-nav-item:focus{text-decoration:none;background-color:rgba(255,255,255,0.1);border-color:transparent}@media (min-width: 48em){.sidebar-item{padding:1.5rem}.sidebar-nav-item{padding-left:1.5rem;padding-right:1.5rem}}.sidebar-checkbox{position:absolute;opacity:0;-webkit-user-select:none;-moz-user-select:none;user-select:none}.sidebar-toggle{position:absolute;top:.8rem;left:1rem;display:flex;align-items:center;padding:.25rem .75rem;color:#505050;background-color:#fff;border-radius:.25rem;cursor:pointer}.sidebar-toggle::before{display:inline-block;width:32px;height:32px;content:"";background:url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='%23555' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' d='M2.5 11.5A.5.5 0 013 11h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4A.5.5 0 013 7h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4A.5.5 0 013 3h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5z' clip-rule='evenodd'/%3E%3C/svg%3E") no-repeat}.sidebar-toggle:active,#sidebar-checkbox:focus~.sidebar-toggle,#sidebar-checkbox:checked~.sidebar-toggle{color:#fff;background-color:#555}.sidebar-toggle:active:before,#sidebar-checkbox:focus~.sidebar-toggle::before,#sidebar-checkbox:checked~.sidebar-toggle::before{background:url("data:image/svg+xml,%3Csvg viewBox='0 0 16 16' fill='%23fff' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' d='M2.5 11.5A.5.5 0 013 11h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4A.5.5 0 013 7h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5zm0-4A.5.5 0 013 3h10a.5.5 0 010 1H3a.5.5 0 01-.5-.5z' clip-rule='evenodd'/%3E%3C/svg%3E") no-repeat}@media (min-width: 30.1em){.sidebar-toggle{position:fixed}}@media print{.sidebar-toggle{display:none}}.wrap,.sidebar,.sidebar-toggle{-webkit-backface-visibility:hidden;-ms-backface-visibility:hidden;backface-visibility:hidden}.wrap,.sidebar-toggle{-webkit-transition:-webkit-transform .3s ease-in-out;transition:transform .3s ease-in-out}#sidebar-checkbox:checked+.sidebar{z-index:10;visibility:visible}#sidebar-checkbox:checked~.sidebar,#sidebar-checkbox:checked~.wrap,#sidebar-checkbox:checked~.sidebar-toggle{-webkit-transform:translateX(14rem);-ms-transform:translateX(14rem);transform:translateX(14rem)}.page,.post{margin-bottom:4em}.page-title,.post-title,.post-title a{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.5rem;margin-bottom:1rem;color:#9a9a9a}.related{padding-top:2rem;padding-bottom:2rem;border-top:1px solid #eee}.related-posts{padding-left:0;list-style:none}.related-posts h3{margin-top:0}.related-posts li small{font-size:75%;color:#999}.related-posts li a:hover{color:#268bd2;text-decoration:none}.related-posts li a:hover small{color:inherit}.pagination{overflow:hidden;margin-left:-1rem;margin-right:-1rem;font-family:"PT Sans", Helvetica, Arial, sans-serif;color:#ccc;text-align:center}.pagination-item{display:block;padding:1rem;border:1px solid #eee}.pagination-item:first-child{margin-bottom:-1px}a.pagination-item:hover{background-color:#f5f5f5}@media (min-width: 30em){.pagination{margin:3rem 0}.pagination-item{float:left;width:50%}.pagination-item:first-child{margin-bottom:0;border-top-left-radius:4px;border-bottom-left-radius:4px}.pagination-item:last-child{margin-left:-1px;border-top-right-radius:4px;border-bottom-right-radius:4px}}.layout-reverse .sidebar{left:auto;right:-14rem}.layout-reverse .sidebar-toggle{left:auto;right:1rem}.layout-reverse #sidebar-checkbox:checked~.sidebar,.layout-reverse #sidebar-checkbox:checked~.wrap,.layout-reverse #sidebar-checkbox:checked~.sidebar-toggle{-webkit-transform:translateX(-14rem);-ms-transform:translateX(-14rem);transform:translateX(-14rem)}.theme-base-08 .sidebar,.theme-base-08 .sidebar-toggle:active,.theme-base-08 #sidebar-checkbox:checked~.sidebar-toggle{background-color:#ac4142}.theme-base-08 .container a,.theme-base-08 .sidebar-toggle,.theme-base-08 .related-posts li a:hover{color:#ac4142}.theme-base-09 .sidebar,.theme-base-09 .sidebar-toggle:active,.theme-base-09 #sidebar-checkbox:checked~.sidebar-toggle{background-color:#d28445}.theme-base-09 .container a,.theme-base-09 .sidebar-toggle,.theme-base-09 .related-posts li a:hover{color:#d28445}.theme-base-0a .sidebar,.theme-base-0a .sidebar-toggle:active,.theme-base-0a #sidebar-checkbox:checked~.sidebar-toggle{background-color:#f4bf75}.theme-base-0a .container a,.theme-base-0a .sidebar-toggle,.theme-base-0a .related-posts li a:hover{color:#f4bf75}.theme-base-0b .sidebar,.theme-base-0b .sidebar-toggle:active,.theme-base-0b #sidebar-checkbox:checked~.sidebar-toggle{background-color:#90a959}.theme-base-0b .container a,.theme-base-0b .sidebar-toggle,.theme-base-0b .related-posts li a:hover{color:#90a959}.theme-base-0c .sidebar,.theme-base-0c .sidebar-toggle:active,.theme-base-0c #sidebar-checkbox:checked~.sidebar-toggle{background-color:#75b5aa}.theme-base-0c .container a,.theme-base-0c .sidebar-toggle,.theme-base-0c .related-posts li a:hover{color:#75b5aa}.theme-base-0d .sidebar,.theme-base-0d .sidebar-toggle:active,.theme-base-0d #sidebar-checkbox:checked~.sidebar-toggle{background-color:#6a9fb5}.theme-base-0d .container a,.theme-base-0d .sidebar-toggle,.theme-base-0d .related-posts li a:hover{color:#6a9fb5}.theme-base-0e .sidebar,.theme-base-0e .sidebar-toggle:active,.theme-base-0e #sidebar-checkbox:checked~.sidebar-toggle{background-color:#aa759f}.theme-base-0e .container a,.theme-base-0e .sidebar-toggle,.theme-base-0e .related-posts li a:hover{color:#aa759f}.theme-base-0f .sidebar,.theme-base-0f .sidebar-toggle:active,.theme-base-0f #sidebar-checkbox:checked~.sidebar-toggle{background-color:#8f5536}.theme-base-0f .container a,.theme-base-0f .sidebar-toggle,.theme-base-0f .related-posts li a:hover{color:#8f5536}.sidebar-overlay #sidebar-checkbox:checked~.wrap{-webkit-transform:translateX(0);-ms-transform:translateX(0);transform:translateX(0)}.sidebar-overlay #sidebar-checkbox:checked~.sidebar-toggle{box-shadow:0 0 0 .25rem #fff}.sidebar-overlay #sidebar-checkbox:checked~.sidebar{box-shadow:0.25rem 0 0.5rem rgba(0,0,0,0.1)}.layout-reverse.sidebar-overlay #sidebar-checkbox:checked~.sidebar{box-shadow:-0.25rem 0 0.5rem rgba(0,0,0,0.1)}.highlight .hll{background-color:#ffc}.highlight .c{color:#999}.highlight .err{color:#a00;background-color:#faa}.highlight .k{color:#069}.highlight .o{color:#555}.highlight .cm{color:#09f;font-style:italic}.highlight .cp{color:#099}.highlight .c1{color:#999}.highlight .cs{color:#999}.highlight .gd{background-color:#fcc;border:1px solid #c00}.highlight .ge{font-style:italic}.highlight .gr{color:#f00}.highlight .gh{color:#030}.highlight .gi{background-color:#cfc;border:1px solid #0c0}.highlight .go{color:#aaa}.highlight .gp{color:#009}.highlight .gu{color:#030}.highlight .gt{color:#9c6}.highlight .kc{color:#069}.highlight .kd{color:#069}.highlight .kn{color:#069}.highlight .kp{color:#069}.highlight .kr{color:#069}.highlight .kt{color:#078}.highlight .m{color:#f60}.highlight .s{color:#d44950}.highlight .na{color:#4f9fcf}.highlight .nb{color:#366}.highlight .nc{color:#0a8}.highlight .no{color:#360}.highlight .nd{color:#99f}.highlight .ni{color:#999}.highlight .ne{color:#c00}.highlight .nf{color:#c0f}.highlight .nl{color:#99f}.highlight .nn{color:#0cf}.highlight .nt{color:#2f6f9f}.highlight .nv{color:#033}.highlight .ow{color:#000}.highlight .w{color:#bbb}.highlight .mf{color:#f60}.highlight .mh{color:#f60}.highlight .mi{color:#f60}.highlight .mo{color:#f60}.highlight .sb{color:#c30}.highlight .sc{color:#c30}.highlight .sd{color:#c30;font-style:italic}.highlight .s2{color:#c30}.highlight .se{color:#c30}.highlight .sh{color:#c30}.highlight .si{color:#a00}.highlight .sx{color:#c30}.highlight .sr{color:#3aa}.highlight .s1{color:#c30}.highlight .ss{color:#fc3}.highlight .bp{color:#366}.highlight .vc{color:#033}.highlight .vg{color:#033}.highlight .vi{color:#033}.highlight .il{color:#f60}.css .o,.css .o+.nt,.css .nt+.nt{color:#999}</style><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400&display=swap"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png"><link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico"><link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml"><body> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><div class="sidebar" id="sidebar"><div class="sidebar-item"><p>A blog on machine learning, probabilistic methods and intelligent systems.</p></div><nav class="sidebar-nav"> <a class="sidebar-nav-item active" href="http://localhost:4000/">Home</a> <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a></nav><div class="sidebar-item"><p> &copy; 2021. All rights reserved.</p></div></div><div class="wrap"><div class="masthead"><div class="container"><h3 class="masthead-title"> <a href="/" title="Home">tensor.blog</a> <small>thinking machines</small></h3></div></div><div class="container content"><div class="posts"><div class="post"><h1 class="post-title"> <a href="http://localhost:4000/2021/07/14/jaegpt/"> Talking to myself using GPT </a></h1><span class="post-date">14 Jul 2021</span><p>Transformer &amp; attention models are all the hype in the machine learning community recently, so I took sometime to learn about them. As a fun project, I’ve decided to build a virtual version of myself (now I will finally have a friend to talk to!).</p><h2 id="data-preparation">Data preparation</h2><p>The training data was prepared through <a href="https://www.facebook.com/dyi/">downloading my entire Facebook chat history</a>, and using a <a href="https://github.com/agiantwhale/jaegpt/blob/master/build_dataset.py">parsing script</a> I wrote. There’s a couple of gotchas when it comes to parsing Facebook messages data:</p><ul><li>Ignore chat threads where most of the language is non-English (Korean is my first language).<li>Remove automated messages (Eg: <em>Words With Friends</em> game requests).<li>Combine consecutive messages into a single sentence.<li>Set a threshold to yield a new context (I’ve chosen this as 50th percentile of message time delta).</ul><p>Overall, the preparation pipeline looks as follows: <img src="/assets/jaegpt/data_gen.png" alt="GPT Data Generation Pipeline" /></p><p>The context of the model is preceding 4 messages before my reply. 3 distractors are chosen from the sent replies in the current chat for the supervision task. I haven’t investigated the effects of these two parameter choices – tuning these context and distractor parameters could be an interesting study.</p><p>The final dataset yields 29192 lines and is 11MB. I’ve split as 25000 lines as training set and the rest 4192 lines as the validation set. This is a fraction of the amount of data the baseline model was trained on (<a href="https://github.com/microsoft/DialoGPT">DialoGPT was trained on 147M multi-turn dialogue from Reddit</a>). Regardless, I found that I was able to get reasonable results with these small datasets.</p><p>Here is the final objective distribution (for a reply of length <img class="inline" src="/latex/latex-79f87014553f5184b3cd09f19cd17710.png" />):</p><p><img class="center" src="/latex/latex-7dbbb6c1c1e864356562ddd86f3865a1.png" /></p><h2 id="model-architecture">Model architecture</h2><p>The architecture is taken directly from the <a href="https://medium.com/huggingface/how-to-build-a-state-of-the-art-conversational-ai-with-transfer-learning-2d818ac26313">HuggingFace’s ConvAI2 (NeurIPS 2018) winning model</a>. The language modeling head is making the actual token predictions, with an extra next sentence classification head added on to the hidden states of the last token to discriminate between the correct reply and a negatively sampled reply. Refer to the linked blogpost and the code for details – the transformer network (and attention module) is a fascinating piece of work that deserves close… <em>attention</em>. For the sake of this post, you can think of the attention module as learning a masking function that focuses on each word in a given sentence (in a <em>fill-in-the-blank</em> manner).</p><p><img src="/assets/jaegpt/model_design.png" alt="GPT2 Double Head Model Design" /></p><p>It seems the discriminator head is designed to act as a weak supervision function to aid language modeling task (through cross learning), but <strong>I didn’t notice any noticable improvements to the main LM task without it.</strong> More details in the following sections.</p><h2 id="training-implementation">Training implementation</h2><p>I’m relying on HuggingFace’s Transformer library to train the model on Google Colab’s TPUs. I ran into several problems, which I mostly fixed by copy-paste engineering and customizing to suit my needs:</p><ul><li>Training on TPU (using <a href="https://github.com/pytorch/xla">pytorch/xla</a>) requires fixed tensor sizes for speed up. This requires some additional care on preprocessing the data part (see block size optimization on parameter tuning section below). I assume this is due to TPU internally optimizing the memory layout.<li>HuggingFace’s Trainer (as of v4.8.2) does not support exporting multiple losses. The final optimization loss is the weighted sum of two tasks: language modeling and next sentence classification, but for final evaluation we only care about the language modeling task. A quick hack to report all three loss is in the code implementation <a href="https://github.com/agiantwhale/jaegpt/blob/master/fbgpt/trainer.py">here</a>.<li>DialoGPT was trained without using token IDs, as a special boolean mask to indicate whether a sentence is a reply or not.</ul><p>The following sections describe the parameter tuning explorations.</p><h3 id="block-size">Block size</h3><p>This is to resolve the fixed tensor requirement with the TPU above. I wrote a script to calculate percentage of training rows that go above limit at each tokenization step. From the chart below, it seems we get a 99% yield with block size of <img class="inline" src="/latex/latex-e0afb0c7a5e6c6ec867e9bbea08b6b10.png" />.</p><p><img src="/assets/jaegpt/block_size.png" alt="GPT2 Double Head Model Design" /></p><p>I’ve updated the data processing step to pad the data to become a fixed width of 128 and ignore rows that overflow – we are good to go.</p><h3 id="epoch">Epoch</h3><p>I kicked off an exploratory run with epoch of 4 to see if multi-epoch training is even reasonable. Small dataset, large model size and sparse tokens seems like a recipe for overfitting, so I chose a batch size of 1 per TPU (which gives us an update batch size of 8, as there are 8 TPU cores). Next sentence prediction task was not used in this run.</p><p><img src="/assets/jaegpt/epoch_tune.png" alt="Train vs Eval in Epoch 4" /></p><p>We seem to overfit after 1 epoch, with eval loss increasing after 2 epoch.</p><h3 id="task-weight-exploration">Task weight exploration</h3><p>For a baseline, below is the entropy of a background predictors that generate a random choice for the two tasks. The DialoGPT tokenizer contains 50257 tokens, and we choose 3 distractors for the next sentence prediction tasks.</p><p><img class="center" src="/latex/latex-7b1b14389b8ed1593e58412ea7b2d214.png" /></p><p>The background entropy for language modeling task is 7.8 times higher than next sentence prediction! A 50% reduction in the classification task would be considered only a 7% reduction in the language modeling task in the final loss function.</p><p>The final loss function is formulaized as</p><p><img class="center" src="/latex/latex-d91e79dee13c6be43f63c0e6011afb9e.png" /></p><p>To verify the potential improvements, I tuned the <img class="inline" src="/latex/latex-c08a7b5eb987e4198f55df3047c97bf7.png" /> in the combined loss to the following values. Reported metrics are eval metrics.</p><table><thead><tr><th><img class="inline" src="/latex/latex-c08a7b5eb987e4198f55df3047c97bf7.png" /><th><img class="inline" src="/latex/latex-480ff5082f729e253113a042a6c9bbac.png" /><th><img class="inline" src="/latex/latex-810c648c5a616153702c17cba3428550.png" /><th><img class="inline" src="/latex/latex-6c9c382af2e89e83ff13a592ab81e473.png" /><th><img class="inline" src="/latex/latex-18fb601c4ccd970049908cca46af8ff2.png" /><th><img class="inline" src="/latex/latex-51e1008cf65efc66bd2ed2b87fc292f3.png" /><tbody><tr><td>100<td>1.819<td>1.312<td>7.814<td>0.722<td><strong>0.0014</strong><tr><td>10<td>1.328<td>0.958<td>5.229<td>0.483<td>0.0012<tr><td>1<td><strong>1.063</strong><td><strong>0.767</strong><td>4.503<td>0.415<td>0.0002<tr><td>0.1<td>1.325<td>0.956<td>4.365<td>0.403<td>0.0002<tr><td>0.01<td>1.386<td>0.999<td><strong>4.361</strong><td><strong>0.402</strong><td>0.0001</table><p>And their corresponding learning curves:</p><p><img src="/assets/jaegpt/lm_loss.png" alt="Eval LM Loss" /></p><p>Using the supervision tasks shows minimal improvement to the main LM loss; rather makes it worse.</p><p><img src="/assets/jaegpt/acc.png" alt="Eval Accuracy" /></p><p>In constract to <img class="inline" src="/latex/latex-6c9c382af2e89e83ff13a592ab81e473.png" />, the inclusion of supervision tasks increase the LM modeling accuracy. However this isn’t a good metric to optimize for, as we will be using beam search to generate responses through sampling; learning an accurate distribution of next token is more important than predicting the most likely token.</p><p><img src="/assets/jaegpt/mc_loss.png" alt="Eval MC Loss" /></p><p>Increasing the <img class="inline" src="/latex/latex-c08a7b5eb987e4198f55df3047c97bf7.png" /> parameter does not result in linear increase to MC loss, with <img class="inline" src="/latex/latex-f6fbad6a2333abe8d09954cff4137205.png" /> showing the best result. In fact, a multiplier of 100 shows a worse result than random guess! I couldn’t think of a reasonable explanation for this; my guess is it has to do with steep gradient magnitudes with higher <img class="inline" src="/latex/latex-c08a7b5eb987e4198f55df3047c97bf7.png" />; plotting magnitude of gradient might give us a better idea here.</p><h3 id="bayes-hyperparameter-optimization">Bayes hyperparameter optimization</h3><p>We did some initial exploration of model architectures; now let’s systematically explore the entire search space to get the best candidate. To do this, we utilize <a href="https://github.com/wandb/client/tree/master/wandb/sweeps">Weights &amp; Biases’ excellent sweep utility</a>, with the <a href="https://github.com/agiantwhale/jaegpt/blob/master/search.yml">config</a> tuned to run various configurations. The sweep algorithm is very simple, it fits a gaussian process regressor on parameter and samples from the trained distribution.</p><p><img src="/assets/jaegpt/sweep.png" alt="Eval MC Loss" /></p><p>The results of the runs are listed below:</p><table><tr><th>Learning Rate<th>MC Task Weight<th>Epoch<th>Batch Size<th>MC Loss<th>LM Loss<tr class="row1"><td class="col1"> 5.18e-05<td class="col2"> 0.0493938<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.2804<td class="col6"> 4.3287<tr class="row1"><td class="col1"> 4.15e-05<td class="col2"> 0.0475979<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.2951<td class="col6"> 4.3339<tr class="row1"><td class="col1"> 4.41e-05<td class="col2"> 0.026687<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.3102<td class="col6"> 4.3351<tr class="row1"><td class="col1"> 6.16e-05<td class="col2"> 0.0051356<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.3154<td class="col6"> 4.3364<tr class="row1"><td class="col1"> 4.66e-05<td class="col2"> 0.0073607<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.3241<td class="col6"> 4.3367<tr class="row1"><td class="col1"> 2.96e-05<td class="col2"> 0.0223147<td class="col3"> 2<td class="col4"> 4<td class="col5"> 1.319<td class="col6"> 4.3451<tr class="row1"><td class="col1"> 5.86e-05<td class="col2"> 0.0147082<td class="col3"> 2<td class="col4"> 4<td class="col5"> 1.2968<td class="col6"> 4.3544<tr class="row1"><td class="col1"> 5.46e-05<td class="col2"> 0.0419673<td class="col3"> 1<td class="col4"> 4<td class="col5"> 1.3124<td class="col6"> 4.3571<tr class="row1"><td class="col1"> 0.0001275<td class="col2"> 0.0195402<td class="col3"> 1<td class="col4"> 8<td class="col5"> 1.3133<td class="col6"> 4.3706<tr class="row1"><td class="col1"> 8.3e-05<td class="col2"> 0.0365972<td class="col3"> 1<td class="col4"> 8<td class="col5"> 1.3181<td class="col6"> 4.3762<tr class="row1"><td class="col1"> 7.55e-05<td class="col2"> 0.0220401<td class="col3"> 3<td class="col4"> 8<td class="col5"> 1.2633<td class="col6"> 4.4274<tr class="row1"><td class="col1"> 8.66e-05<td class="col2"> 0.022435<td class="col3"> 3<td class="col4"> 8<td class="col5"> 1.2549<td class="col6"> 4.4661<tr class="row1"><td class="col1"> 9.43e-05<td class="col2"> 0.0229404<td class="col3"> 3<td class="col4"> 8<td class="col5"> 1.262<td class="col6"> 4.4974<tr class="row1"><td class="col1"> 0.0008321<td class="col2"> 0.011086<td class="col3"> 1<td class="col4"> 4<td class="col5"> 1.3276<td class="col6"> 5.1287<tr class="row1"><td class="col1"> 0.0014851<td class="col2"> 0.0079413<td class="col3"> 1<td class="col4"> 4<td class="col5"> 1.3417<td class="col6"> 5.9006<tr class="row1"><td class="col1"> 0.0001262<td class="col2"> 46.8726004<td class="col3"> 2<td class="col4"> 8<td class="col5"> 1.334<td class="col6"> 7.0459</table><p>I’ve kicked off a final training run with all data with the following parameters:</p><ul><li><img class="inline" src="/latex/latex-afeb466cb4ee4edf8f6319eee1fb93a8.png" /><li><img class="inline" src="/latex/latex-24bd77d4a18ce9f7dc612e1f5f62d506.png" /><li><img class="inline" src="/latex/latex-b67d941e3161239fe32db79dd933e200.png" /><li><img class="inline" src="/latex/latex-5f7a43e67fa4762254dbdb150b39e8a0.png" /></ul><h2 id="conversation-examples">Conversation examples</h2><p>I’ve generated some samples using the <a href="https://github.com/agiantwhale/jaegpt/blob/master/interact.py">generator script in the repository</a>. It relies on HuggingFace’s implementation of beam search, where a token is sampled from the predicted distribution of tokens (with previous tokens as the prior). After some trial and error I’ve arrived at <img class="inline" src="/latex/latex-1e1e36d25130ce0cc23586ce5aa776f9.png" /> (filter out tokens where probability is &lt; 0.25, and choose top 100 tokens).</p><h3 id="jae-gpt-on-his-hobbies">Jae-GPT on his hobbies.</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; What hobbies do you enjoy in your free time
JaeGPT: I'm not sure what I enjoy in free time, but I'm not really into hip hop or



&gt;&gt;&gt; Are you actively working on developing your hobbies
JaeGPT: I like to listen to music and play video games, but also like to play video game games and



&gt;&gt;&gt; Which video games?
JaeGPT: I'm working on a game called Minecraft that's pretty fun and addictive, but it's not optimized



&gt;&gt;&gt; You're trying to create Minecraft
JaeGPT: I don't think Minecraft is a good idea for a first time user. It's a lot of


</code></pre></div></div><h3 id="jae-gpt-on-collecting-wrist-watches">Jae-GPT on collecting wrist watches.</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; Do you like collecting wristwatches
JaeGPT: I don't like watches but I like watches that look cool and I like the design of them and



&gt;&gt;&gt; Which watch do you think looks the coolest
JaeGPT: I like watches with a nice design and a good finish but I don't really like watches as a



&gt;&gt;&gt; as a tool?
JaeGPT: I think it looks pretty cool but I think it's too much work for me to wear everyday lol



&gt;&gt;&gt; I like to wear my nomos everyday
JaeGPT: i don't like watches that's too formal but i like watches for everyday wear so i'll probably



&gt;&gt;&gt; wear an apple watch?
JaeGPT: I'm thinking of buying a watch with a strap that's more comfortable to wear on the wrist and


</code></pre></div></div><h3 id="jae-gpt-on-discussing-the-stock-market">Jae-GPT on discussing the stock market.</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; Should I buy some options on Robinhood
JaeGPT: What's Robinhood? I'm not sure if it's a mutual fund or not lololol



&gt;&gt;&gt; It's a brokerage
JaeGPT: I'm not a big investor in Robinhood but I'm a big fan of the company and I



&gt;&gt;&gt; Are you bullish or bearish on Robinhood
JaeGPT: I think I'm bullish on Robin hood but I think I'll be bullish on Amazon and Google too



&gt;&gt;&gt; So you like all the tech stocks
JaeGPT: I'm bullish for Robinhood too but I don't think I can get into FB or Google lol



&gt;&gt;&gt; But you work for Facebook
JaeGPT: I think you can get a job at Google or Amazon too if you're a tech company and you


</code></pre></div></div><h3 id="jae-gpt-on-wealth-accumulation">Jae-GPT on wealth accumulation.</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt; What kind of life do you want to live?
JaeGPT: I want to be a billionaire but I don't want to go back to school and live a life



&gt;&gt;&gt; It's not easy to become a billionaire.
JaeGPT: I'm not sure if I can do that But I'm willing to try my best to make it



&gt;&gt;&gt; Get rich or die trying
JaeGPT: I want a billionaire to live a long life so I can be a millionaire again and live the rest



&gt;&gt;&gt; You're going to become a millionaire from a billionaire?
JaeGPT: I'm going to be a billionaire from a millionaire I'm going into a billionaire I'm not going


</code></pre></div></div></div><div class="post"><h1 class="post-title"> <a href="http://localhost:4000/2020/08/03/group-lasso/"> Intuitive Explanation of Group LASSO Regularization for Neural Network Interpretability </a></h1><span class="post-date">03 Aug 2020</span><p>Neural networks are often referred to as a black box model because of its lack of interpretability. Most of a network’s operations occur in the hidden layers and latent space. As a result, tracing important features in a dataset is not an easy task, especially when the number of features is large. This is often a limiting factor in applying neural networks in fields where explainability is not only favored, but crucial (such as medical diagnostics or finance).</p><p>Through this entry, we hope to examine the application of the group LASSO regularization for solving the problems described above.</p><h2 id="what-is-ridge-and-lasso-regularization">What is ridge and LASSO regularization?</h2><p>The loss function of ridge regression can be defined as</p><p><img class="center" src="/latex/latex-b832c44e16abdcd71034eb8a69f73d4f.png" /></p><p>while loss function of LASSO regression can be defined as</p><p><img class="center" src="/latex/latex-c706b7933e2425517886943a7c4855dd.png" /></p><p>The above loss functions can be broken down into</p><ul><li>Predicted output: <img class="inline" src="/latex/latex-1f625f17552856d6463fcac3c32101b3.png" /><li>Regularization term<ul><li><img class="inline" src="/latex/latex-c343adb0c473016c19f48b35e9ee1923.png" /> for LASSO<li><img class="inline" src="/latex/latex-fa17a9b380844ff87dc1095a6f843f17.png" /> for ridge</ul></ul><p>Comparison of the two regularization terms shows the intuition behind LASSO regression’s better interpretability characteristics. From a Big-O standpoint, <img class="inline" src="/latex/latex-f037b2a8bf7aa27b03b3a16f052acd06.png" />. The penalty for having one skewed large value is much greater for ridge regression. Ridge regularization aims to reduce variance between the coefficients, therefore driving all features down to zero.</p><p>LASSO regularization, on the other hand, will set some feature’s coefficients to zero values when deemed necessary, effectively removing them. We then can compare non-zero coefficients to determine the importance of the features.</p><h2 id="what-is-group-lasso-regularization">What is group LASSO regularization?</h2><p>From the above example, we observe how LASSO regularization can help with the interpretability of the model. But some problems may benefit from a group of features used together, especially when incorporating domain knowledge into the model.</p><p>Group LASSO attempts to solve this problem by separating the entire feature set into separate feature groups. The regularization function can be written as</p><p><img class="center" src="/latex/latex-982f81b039618d09108f899cf26f46c5.png" /></p><p>where</p><ul><li><img class="inline" src="/latex/latex-10afdb7058d58d26e17462afab5184e1.png" /> denotes the size of the group.<li><img class="inline" src="/latex/latex-1260e71e0fc41670c2fe966156d4aa01.png" /> denotes the L2-norm of the feature group <img class="inline" src="/latex/latex-4322e011bfdf0bfdc4c27891ff3dfc61.png" />.</ul><p>Let’s take a closer look at the regularization term <img class="inline" src="/latex/latex-efcb5f9f42d3fc2659fff45d27825d09.png" />.</p><p>Note that <img class="inline" src="/latex/latex-04f7d616922df5bee90be4315df5bd74.png" />, and we for some <img class="inline" src="/latex/latex-3fc4979464ed4d76e333e61e3bd92615.png" /> that satisfies <img class="inline" src="/latex/latex-d9cbfed9c4e18f1438b295b5ed388b2c.png" />, we could effectively rewrite the equation as</p><p><img class="center" src="/latex/latex-502db40ff96a3f8501db90bbd383a2f1.png" /></p><p>In this case, we have effectively reduced the regularization to LASSO regularization on the inter-group level.</p><p>Similarly, let’s take a look an subgroup. Expanding the term for some group with cardinality <img class="inline" src="/latex/latex-cf56f66cf006f2f909a26e2840fb3197.png" />, the regularization term can be expressed as</p><p><img class="center" src="/latex/latex-ef2df46f53bb8711bf2f93489981cbfc.png" /></p><p>Here, we have effectively reduced the regularization to ridge regularization on the intra-group level.</p><p>We build on the intuition that while it cannot select certain features within the same group, because of it’s LASSO-like nature between feature groups, the model will zero-out entirety of certain coefficient groups.</p><p>Additionally, note the two following characteristics:</p><ul><li>When <img class="inline" src="/latex/latex-b509903172b539c1855c10cb08e2b0a9.png" />, the regularization term essentially becomes a LASSO (L1) regularization.<li>When <img class="inline" src="/latex/latex-67dc231cbb67be814d1770bc40e27f66.png" />, the regularization term essentially becomes a ridge (L2) regularization.</ul><h2 id="how-can-we-adapt-group-lasso-for-neural-networks">How can we adapt group LASSO for neural networks?</h2><p>Up to now, the application of regularization terms have been on linear regression methods where each features are assigned a single coefficient weight. Now, we will take a look at a neural network, specifically on the connections between the first two layer of the network, where each individual features have multiple weights associated to the next layer.</p><p>To visualize this, say we have a small neural network with one hidden layer.</p><p><img class="center" src="/latex/latex-676b7e3e942012b08f4761cb52d6598c.png" /></p><p>In order for the above feature selection to work, we will need to zero out the weights connected for all of feature <img class="inline" src="/latex/latex-63ac1428cb664318e538521970b9c31d.png" /> (marked in red).</p><p><img class="center" src="/latex/latex-6380075deae1b69a4865b8777a069e99.png" /></p><p>In this case, the weights associated with each of the neurons becomes becomes a group of their own. Let <img class="inline" src="/latex/latex-588e7585b44191d96d5d21a3b0f9d8af.png" /> and <img class="inline" src="/latex/latex-f78c1d7bf8cdc1fa8475ee763ebaa13f.png" /> denote the weight vectors for input features <img class="inline" src="/latex/latex-a61fcbe9f079dadb08038189261d695e.png" /> and <img class="inline" src="/latex/latex-63ac1428cb664318e538521970b9c31d.png" /> (<img class="inline" src="/latex/latex-f78c1d7bf8cdc1fa8475ee763ebaa13f.png" /> weights would be marked in red above). We can adapt the group LASSO regularization formulation as</p><p><img class="center" src="/latex/latex-ef01b74a4d23c0555bc00ca85c7fcbaa.png" /></p><p>where <img class="inline" src="/latex/latex-ad4c0ceaad058aef6ccf3e724ca12b9a.png" /> denotes the loss function and <img class="inline" src="/latex/latex-3035883f6531462455e562d330180152.png" /> denotes the full-connected weights to feature <img class="inline" src="/latex/latex-7bdce1f20016bc5e7197ccbbb0a86fab.png" />. Since we have two input features, the regularization term would also expand to</p><p><img class="center" src="/latex/latex-987cc3e980a19372984ddcd977ea3a9a.png" /></p><p>We have essentially derived the Group level lasso regularization on each of the individual features, with the weights corresponding to each feature in a group. We can continue to build on the intuition from the Group LASSO.</p><p>While each individual weights inside a weight group will not differ in terms of convergence to zero (all elements of <img class="inline" src="/latex/latex-588e7585b44191d96d5d21a3b0f9d8af.png" />, <img class="inline" src="/latex/latex-f78c1d7bf8cdc1fa8475ee763ebaa13f.png" /> will either be zero or non-zero), the non-continuous nature of the l2 norm for individual features will introduce sparsity and converge entire feature weights to 0.</p><p>From here, it’s trivial to apply the same technique to regularizing hidden layers to introduce further sparsity to the model and improve model capacity or prune unneeded connections.</p><h2 id="references">References</h2><ul><li><a href="https://icml.cc/Conferences/2010/papers/473.pdf">Yang, Haiqin et al. “Online Learning for Group Lasso.” <em>ICML</em> (2010).</a><li><a href="https://arxiv.org/abs/1607.00485">Scardapane, Simone et al. “Group Sparse Regularization for Deep Neural Networks.” Neurocomputing 241 (2017): 81–89. Crossref. Web.</a></ul></div></div><div class="pagination"> <span class="pagination-item older">Older</span> <span class="pagination-item newer">Newer</span></div></div></div><label for="sidebar-checkbox" class="sidebar-toggle"></label> <script> (function(document) { var toggle = document.querySelector('.sidebar-toggle'); var sidebar = document.querySelector('#sidebar'); var checkbox = document.querySelector('#sidebar-checkbox'); document.addEventListener('click', function(e) { var target = e.target; if(!checkbox.checked || sidebar.contains(target) || (target === checkbox || target === toggle)) return; checkbox.checked = false; }, false); })(document); </script>
